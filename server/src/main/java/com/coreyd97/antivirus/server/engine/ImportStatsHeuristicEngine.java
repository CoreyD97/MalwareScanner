package com.coreyd97.antivirus.server.engine;

import com.coreyd97.antivirus.common.report.ResultsReport;
import com.coreyd97.antivirus.common.taskscheduler.AnalysisTask;
import com.coreyd97.antivirus.server.AntiVirusServer;
import com.coreyd97.antivirus.common.report.ScanReport;
import com.coreyd97.antivirus.common.report.TrainReport;
import com.coreyd97.antivirus.common.taskscheduler.FileTask;
import com.coreyd97.antivirus.common.utils.Utils;
import com.github.katjahahn.parser.FileFormatException;
import com.github.katjahahn.parser.PEData;
import com.github.katjahahn.parser.PELoader;
import com.github.katjahahn.parser.sections.SectionLoader;
import com.github.katjahahn.parser.sections.idata.ImportSection;

import java.io.File;
import java.io.IOException;
import java.sql.SQLException;

public class ImportStatsHeuristicEngine extends ServerScannerEngine {
    public static final String engineName = "Function Import Heuristic";
    boolean storeSampleFunctionUsage;

    public ImportStatsHeuristicEngine(){
        super(engineName, true);
        storeSampleFunctionUsage = AntiVirusServer.getInstance().getOptions().getValue("storeFunctionUsage", Boolean.class, false);
    }

    @Override
    public AnalysisTask processReports(ScanReport[] scanReports) {
        AnalysisTask analysisTask = new ImportStatsAnalysisTask("Import Stats Report Analysis", scanReports, new ResultsReport());
        AntiVirusServer.getInstance().getTaskScheduler().registerTask(analysisTask);
        return analysisTask;
    }


    private class ImportStatsAnalysisTask extends AnalysisTask {
        protected ImportStatsAnalysisTask(String taskName, ScanReport[] reports, ResultsReport resultsReport) {
            super(taskName, reports, resultsReport);
        }

        @Override
        protected void processReport(ScanReport report) {
            //TODO ProcessReport - Import Stats
        }
    }


    @Override
    public FileTask train(File files[]){
        Utils.FileStatus fileStatus = Utils.cleanOrDirtyConfirmation();
        FileTask trainTask = new ImportStatsTrainTask("Heuristic Training", files, fileStatus, new TrainReport(this));
        AntiVirusServer.getInstance().getTaskScheduler().registerTask(trainTask);
        return trainTask;
    }

    public class ImportStatsTrainTask extends FileTask {
        Utils.FileStatus fileStatus;

        ImportStatsTrainTask(String taskName, File files[], Utils.FileStatus fileStatus, TrainReport trainReport){
            super(taskName, files, trainReport);
            this.fileStatus = fileStatus;
        }

        @Override
        protected void processFile(File file) {
            try {
                PEData data = PELoader.loadPE(file);
                ImportSection section;
                Integer sampleID = null;
                if (this.fileStatus == Utils.FileStatus.DIRTY) {
                    if (db.containsSample(file)) {
                        ((TrainReport) this.report).addFailedSample("Sample already present.", file.getAbsolutePath());
                        return;
                    }
                    sampleID = db.addSample(file, fileStatus);
                }
                SectionLoader sectionLoader = new SectionLoader(data);
                section = sectionLoader.loadImportSection();

                db.storeSampleImports(sampleID, section.getImports(), fileStatus, storeSampleFunctionUsage);
                ((TrainReport) this.report).trainedSamples++;
            } catch (IOException | IllegalStateException e) {
                String cause;
                if (e instanceof FileFormatException) {
                    cause = "Invalid PE32 File. ";
                } else if (e instanceof IllegalStateException) {
                    cause = "Could not find import section. ";
                } else {
                    cause = "Could not open file. ";
                }
                ((TrainReport) this.report).addFailedSample(cause, file.getAbsolutePath());
            } catch (SQLException e) {
                System.err.println(e.getMessage());
            }
        }
    }



}

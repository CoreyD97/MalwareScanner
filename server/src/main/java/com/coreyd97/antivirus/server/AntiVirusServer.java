package com.coreyd97.antivirus.server;

import com.coreyd97.antivirus.common.Options;
import com.coreyd97.antivirus.common.network.ServerConnectionHandler;
import com.coreyd97.antivirus.common.stats.StatProvider;
import com.coreyd97.antivirus.common.stats.StatProviderManager;
import com.coreyd97.antivirus.common.taskscheduler.TaskScheduler;
import com.coreyd97.antivirus.server.engine.AnalysisManager;
import com.coreyd97.antivirus.server.engine.AnalysisModule;
import com.coreyd97.antivirus.server.network.AVClientHandler;
import com.coreyd97.antivirus.server.network.ClientManager;
import com.coreyd97.antivirus.server.taskscheduler.FirewallWhitelistTask;
import com.coreyd97.antivirus.server.ui.AntiVirusUI;

import javax.swing.*;
import java.io.IOException;
import java.net.InetAddress;
import java.net.UnknownHostException;
import java.sql.SQLException;
import java.util.logging.Logger;

public class AntiVirusServer {
    private Options options;
    private DatabaseEngine databaseEngine;

    private final AVClientHandler serverNetworkController;
    private final ClientManager clientManager;
    private final TaskScheduler taskScheduler;
    private final AnalysisManager analysisManager;
    private final StatProviderManager statProviderManager;
    private final ServerConnectionHandler firewallConnection;

    public AntiVirusServer() {
        this.options = new Options();
        this.statProviderManager = new StatProviderManager();

        try {
            this.databaseEngine = new DatabaseEngine();
            this.statProviderManager.addStatProvider(this.databaseEngine);
        } catch (SQLException e) {
            e.printStackTrace();
        } catch (ClassNotFoundException e) {
            System.err.println("Could not find H2 database drivers.");
        }


        //ServerThread
        short listenPort = this.options.getValue("server.port", Short.class, (short) 4396);
        AVClientHandler tempClientHandler;
        try {
            tempClientHandler = new AVClientHandler(this, listenPort);
        } catch (IOException e) {
            tempClientHandler = null;
            System.err.println("Could not bind server to port " + listenPort);
            System.exit(0);
        }
        this.serverNetworkController = tempClientHandler;
        serverNetworkController.start();


        //Firewall Connection
        String firewallAddress = this.options.getValue("firewall.address", String.class, "192.168.1.1");
        InetAddress firewallINetAddr = null;
        try {
            firewallINetAddr = InetAddress.getByName(firewallAddress);
        } catch (UnknownHostException e) {}
        short firewallPort = this.options.getValue("firewall.port", Integer.class, 4397).shortValue();
        this.firewallConnection = new ServerConnectionHandler(firewallINetAddr, firewallPort);

        //TaskScheduler
        this.taskScheduler = new TaskScheduler(25);
        this.statProviderManager.addStatProvider(this.taskScheduler);
        //ClientManager
        this.clientManager = new ClientManager(firewallConnection, taskScheduler);
        this.statProviderManager.addStatProvider(this.clientManager);
        //AnalysisManager
        this.analysisManager = new AnalysisManager(this.taskScheduler, this.clientManager, this.databaseEngine);
        for (AnalysisModule analysisModule : this.analysisManager.getAnalysisModules()) {
            if(analysisModule instanceof StatProvider){
                this.statProviderManager.addStatProvider((StatProvider) analysisModule);
            }
        }
    }

    public static void main(String[] args) {
        AntiVirusServer antiVirusServer = new AntiVirusServer();

        SwingUtilities.invokeLater(() -> new AntiVirusUI(antiVirusServer));


        FirewallWhitelistTask whitelistTask = new FirewallWhitelistTask(antiVirusServer.getFirewallConnection());
        whitelistTask.setCallback(() -> {
            if(!whitelistTask.getResult()){
                Logger.getAnonymousLogger().warning("Could not whitelist AV server from firewall!" +
                        "\nBanned clients will not be able to connect to the server!");
            }
        });
        antiVirusServer.getTaskScheduler().execute(whitelistTask);

    }

    public Options getOptions() {
        return options;
    }

    public void shutdown(){
        databaseEngine.shutdown();
        System.exit(0);
    }

//    public static AntiVirusServer getInstance() {
//        if (instance == null) instance = new AntiVirusServer();
//        return instance;
//    }

    public DatabaseEngine getDatabaseEngine() {
        return databaseEngine;
    }

    public TaskScheduler getTaskScheduler() {
        return taskScheduler;
    }

    public AnalysisManager getAnalysisManager() {
        return analysisManager;
    }

    public StatProviderManager getStatProviderManager() {
        return statProviderManager;
    }

    public ServerConnectionHandler getFirewallConnection() {
        return firewallConnection;
    }
}

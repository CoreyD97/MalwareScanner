package com.coreyd97.antivirus.server.network;

import com.coreyd97.antivirus.common.network.ClientConnection;
import com.coreyd97.antivirus.common.network.ServerThread;
import com.coreyd97.antivirus.common.network.NetworkListener;
import com.coreyd97.antivirus.common.report.IReportAdapter;
import com.coreyd97.antivirus.common.report.Report;
import com.coreyd97.antivirus.common.report.ResultsReport;
import com.coreyd97.antivirus.common.report.ScanReport;
import com.coreyd97.antivirus.common.taskscheduler.TrainTask;
import com.coreyd97.antivirus.common.utils.Utils;
import com.coreyd97.antivirus.server.AntiVirusServer;
import com.coreyd97.antivirus.server.engine.ImportStatsAnalysisModule;
import com.coreyd97.antivirus.server.engine.RulesAnalysisModule;
import com.coreyd97.antivirus.server.engine.UnknownModuleException;
import com.coreyd97.c45.TreeNode;
import com.google.gson.*;

import java.io.*;
import java.net.Socket;
import java.sql.SQLException;
import java.util.UUID;
import java.util.logging.Logger;

public class AVClientConnection extends ClientConnection {

    public AVClientConnection(ServerThread serverThread, Socket clientSocket){
        super(serverThread, clientSocket);
    }

    @Override
    public void run() {
        BufferedReader bufferedReader;
        PrintWriter outputStream;

        try{
            bufferedReader = new BufferedReader(new InputStreamReader(socket.getInputStream()));
            outputStream = new PrintWriter(socket.getOutputStream(), true);
        } catch (IOException e) {
            for (NetworkListener networkListener : serverThread.getListeners()) {
                networkListener.onNetworkError((ClientNetworkException) e);
            }
            return;
        }

        String line;
        while(!this.socket.isClosed()){
            try{
                line = bufferedReader.readLine();
                switch(line){
                    case "Identify": {
                        outputStream.println("CerberusAVServer");
                        this.socket.close();
                        break;
                    }
                    case "Analyse": {
                        JsonParser jsonParser = new JsonParser();
                        line = bufferedReader.readLine();
                        try{
                            JsonObject jsonObject = (JsonObject) jsonParser.parse(line);
                            if(jsonObject.get("type").getAsString().equals("ScanReport")){
                                ScanReport scanReport = new Gson().fromJson(line,ScanReport.class);

                                //Submit for analysis
                                Logger.getLogger("ANALYSIS").info("Scan Report Received - " + scanReport.getUUID());
                                ((ClientHandler) serverThread).getAVServer().getAnalysisManager().requestAnalysis(scanReport);
                                outputStream.println("ACCEPT " + scanReport.getUUID());
                            }else{
                                outputStream.println("DENY The submitted scanReport was not a ScanReport!");
                            }
                        }catch (JsonParseException parseException){
                            outputStream.println("DENY Could not parse the received ScanReport!");
                        } catch (UnknownModuleException moduleException) {
                            outputStream.println("DENY " + moduleException.getMessage());
                        }
                        this.socket.close();
                        break;
                    }
                    case "Explain": {
                        JsonParser jsonParser = new JsonParser();
                        line = bufferedReader.readLine();
                        try{
                            JsonObject jsonObject = (JsonObject) jsonParser.parse(line);
                            if(jsonObject.get("type").getAsString().equals("ScanReport")){
                                ScanReport scanReport = new Gson().fromJson(line,ScanReport.class);

                                //Submit for analysis
                                Logger.getLogger("Explain").info("Scan Report Received - " + scanReport.getUUID());
                                ((ClientHandler) serverThread).getAVServer().getAnalysisManager().requestExplanation(scanReport);
                                outputStream.println("ACCEPT " + scanReport.getUUID());
                            }else{
                                outputStream.println("DENY The submitted scanReport was not a ScanReport!");
                            }
                        }catch (JsonParseException parseException){
                            outputStream.println("DENY Could not parse the received ScanReport!");
                        } catch (UnknownModuleException moduleException) {
                            outputStream.println("DENY " + moduleException.getMessage());
                        }
                        this.socket.close();
                        break;
                    }
                    case "Results": {
                        while (!(line = bufferedReader.readLine()).equals("END")) {
                            UUID uuid = UUID.fromString(line);
                            ResultsReport resultsReport = ((ClientHandler) serverThread).getAVServer().getAnalysisManager().getReport(uuid);
                            if (resultsReport == null) {
                                outputStream.println("PENDING");
                            } else {
                                Gson gson = new GsonBuilder().registerTypeAdapter(Report.class, new IReportAdapter()).create();
                                outputStream.println(gson.toJson(resultsReport, Report.class));
                            }
                        }
                        this.socket.close();
                        break;
                    }

                    case "BUILDIMPORTTREE": {
                        this.socket.close();
                        ImportStatsAnalysisModule module = (ImportStatsAnalysisModule) ((ClientHandler) serverThread).getAVServer().getAnalysisManager().getAnalysisModule(ImportStatsAnalysisModule.engineName);
                        try {
                            module.createTree();
                        } catch (SQLException e) {
                            e.printStackTrace();
                        }
                        break;
                    }

                    case "BUILDYARATREE": {
                        this.socket.close();
                        RulesAnalysisModule module = (RulesAnalysisModule) ((ClientHandler) serverThread).getAVServer().getAnalysisManager().getAnalysisModule(RulesAnalysisModule.engineName);
                        try {
                            module.createTree();
                        } catch (SQLException e) {
                            e.printStackTrace();
                        }
                        break;
                    }

                    case "YARATREE": {
                        File treeFile = new File("./config/yaraRuleTree");
                        try {
                            TreeNode decisionTree = new Gson().fromJson(new FileReader(treeFile), TreeNode.class);
                            decisionTree.print();
                        } catch (FileNotFoundException e) {
                            e.printStackTrace();
                            //TODO handle missing decision tree.
                            //TODO Add ability for server to report errors to client w/r processing reports.
                        }
                        this.socket.close();
                        break;
                    }

                    case "IMPORTTREE": {
                        File treeFile = new File("./config/importRuleTree");
                        try {
                            TreeNode decisionTree = new Gson().fromJson(new FileReader(treeFile), TreeNode.class);
                            decisionTree.print();
                        } catch (FileNotFoundException e) {
                            e.printStackTrace();
                            //TODO handle missing decision tree.
                            //TODO Add ability for server to report errors to client w/r processing reports.
                        }
                        this.socket.close();
                        break;
                    }
                }
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
    }



    public static class ClientNetworkException extends IOException{}
}
package com.coreyd97.antivirus.server.network;

import com.coreyd97.antivirus.common.report.IReportAdapter;
import com.coreyd97.antivirus.common.report.Report;
import com.coreyd97.antivirus.common.report.ResultsReport;
import com.coreyd97.antivirus.common.report.ScanReport;
import com.coreyd97.antivirus.server.AntiVirusServer;
import com.coreyd97.antivirus.server.engine.AnalysisManager;
import com.coreyd97.antivirus.server.engine.UnknownModuleException;
import com.google.gson.*;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.PrintWriter;
import java.net.Socket;
import java.util.UUID;
import java.util.concurrent.Future;
import java.util.logging.Logger;

public class ClientConnection extends Thread {
    final ServerNetworkController serverNetworkController;
    final Socket socket;


    public ClientConnection(ServerNetworkController serverNetworkController, Socket clientSocket){
        this.serverNetworkController = serverNetworkController;
        this.socket = clientSocket;
    }

    @Override
    public void run() {
        BufferedReader bufferedReader;
        PrintWriter outputStream;

        try{
            bufferedReader = new BufferedReader(new InputStreamReader(socket.getInputStream()));
            outputStream = new PrintWriter(socket.getOutputStream(), true);
        } catch (IOException e) {
            for (NetworkListener networkListener : serverNetworkController.getListeners()) {
                networkListener.onNetworkError((ClientNetworkException) e);
            }
            return;
        }

        String line;
        while(!this.socket.isClosed()){
            try{
                line = bufferedReader.readLine();
//                Logger.getLogger("NETWORK").info("Received: " + line);
                switch(line){
                    case "Identify": {
                        outputStream.println("CerberusAVServer");
                        this.socket.close();
                        break;
                    }
                    case "Analyse": {
                        line = bufferedReader.readLine();
                        try{
                            JsonObject jsonObject = (JsonObject) new JsonParser().parse(line);
                            if(jsonObject.get("type").getAsString().equals("ScanReport")){
                                ScanReport scanReport = new Gson().fromJson(line,ScanReport.class);

                                //Submit for analysis
                                Logger.getLogger("ANALYSIS").info("Scan Report Received - " + scanReport.getUUID());
                                Future future = AntiVirusServer.getInstance().getAnalysisManager().requestAnalysis(scanReport);
                                outputStream.println("ACCEPT " + scanReport.getUUID());
                            }else{
                                outputStream.println("DENY The submitted report was not a ScanReport!");
                            }
                        }catch (JsonParseException parseException){
                            outputStream.println("DENY Could not parse the received ScanReport!");
                        } catch (UnknownModuleException moduleException) {
                            outputStream.println("DENY " + moduleException.getMessage());
                        }
                        this.socket.close();
                        break;
                    }
                    case "Results": {
                        while (!(line = bufferedReader.readLine()).equals("END")) {
                            UUID uuid = UUID.fromString(line);
                            ResultsReport resultsReport = AntiVirusServer.getInstance().getAnalysisManager().getReport(uuid);
                            if (resultsReport == null) {
                                outputStream.println("PENDING");
                            } else if(resultsReport.getFoundMalware().size() == 0) {
                                outputStream.println("CLEAN");
                            } else {
                                Gson gson = new GsonBuilder().registerTypeAdapter(Report.class, new IReportAdapter()).create();
                                outputStream.println(gson.toJson(resultsReport, Report.class));
                            }
                        }
                        this.socket.close();
                    }
                }
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
    }



    public static class ClientNetworkException extends IOException{}
}
package com.coreyd97.antivirus.server.engine;

import com.coreyd97.antivirus.common.report.ReportHandler;
import com.coreyd97.antivirus.common.report.ResultsReport;
import com.coreyd97.antivirus.common.report.ScanReport;
import com.coreyd97.antivirus.common.taskscheduler.AnalysisTask;
import com.coreyd97.antivirus.common.taskscheduler.TaskScheduler;
import com.coreyd97.antivirus.server.DatabaseEngine;
import com.coreyd97.antivirus.server.network.ClientHandler;
import com.coreyd97.antivirus.server.taskscheduler.ExplainTask;
import org.reflections.Reflections;

import java.lang.reflect.Field;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Modifier;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Set;
import java.util.UUID;
import java.util.logging.Logger;

public class AnalysisManager implements ReportHandler<ResultsReport> {
    private final TaskScheduler taskScheduler;
    private final DatabaseEngine db;
    private HashMap<String, AnalysisModule> analysisModules;
    private HashMap<UUID, ResultsReport> resultsReports;

    public AnalysisManager(TaskScheduler taskScheduler, DatabaseEngine db) {
        this.taskScheduler = taskScheduler;
        this.db = db;
        this.resultsReports = new HashMap<>();
        loadDetectionModules();
    }

    //Register request for a scan with the scheduler. This will be executed when scheduler is ready.
    public void requestAnalysis(ScanReport scanReport) throws UnknownModuleException {
        AnalysisModule detectionModule = analysisModules.get(scanReport.getDetectionModule());
        if(detectionModule == null){ throw new UnknownModuleException(scanReport.getDetectionModule()); }
        AnalysisTask analysisTask = detectionModule.processReport(scanReport);
        analysisTask.setReportHandler(this);
        taskScheduler.execute(analysisTask);
    }

    public void requestExplanation(ScanReport scanReport) throws UnknownModuleException {
        AnalysisModule detectionModule = analysisModules.get(scanReport.getDetectionModule());
        if(detectionModule == null){ throw new UnknownModuleException(scanReport.getDetectionModule()); }
        ExplainTask explainTask = detectionModule.explain(scanReport);
        explainTask.setReportHandler(this);
        taskScheduler.execute(explainTask);
    }

    @Override
    public void onReportReady(ResultsReport report) {
        resultsReports.put(report.getUUID(), report);
        if(report.getFoundMalware().size() > 0){
            //TODO Malware Detected! Quarantine the system.
        }
    }

//    @Override
//    public void onTaskStart(Task task, int steps) {
//        activeAnalysisTasks.put(task.getUUID(), (AnalysisTask) task);
//    }
//
//    @Override
//    public void onTaskStepsAdded(Task task, int steps) {}
//
//    @Override
//    public void onTaskProgress(Task task) {}
//
//    @Override
//    public void onTaskComplete(Task task) {
//        activeAnalysisTasks.remove(task.getUUID());
//    }

    public ResultsReport getReport(UUID uuid){
        return resultsReports.remove(uuid);
    }

    private void loadDetectionModules() {
        this.analysisModules = new HashMap<>();
        Reflections reflections = new Reflections("com.coreyd97.antivirus.server.engine");
        Set<Class<? extends AnalysisModule>> analysisModule = reflections.getSubTypesOf(AnalysisModule.class);
        for (Class<? extends AnalysisModule> module : analysisModule) {
            if(Modifier.isAbstract(module.getModifiers())) continue;
            String name; //Try to get engine name defined in class. Otherwise use file name.
            try {
                Field f = module.getField("engineName");
                name = (String) f.get(null);
            } catch (NoSuchFieldException | IllegalAccessException e) {
                name = module.getName();
            }
            AnalysisModule instance;
            try {
                instance = module.getConstructor(DatabaseEngine.class).newInstance(this.db);
                this.analysisModules.put(name, instance);
            } catch (InstantiationException | IllegalAccessException | InvocationTargetException | NoSuchMethodException e) {
                Logger.getLogger("AnalysisManager").warning("Analysis module " + name + " could not be loaded!");
            }
        }
    }

    public AnalysisModule getAnalysisModule(String analysisModule){
        if(this.analysisModules != null) return this.analysisModules.get(analysisModule);
        else return null;
    }

    public ArrayList<AnalysisModule> getAnalysisModules() {
        return new ArrayList<>(analysisModules.values());
    }
}


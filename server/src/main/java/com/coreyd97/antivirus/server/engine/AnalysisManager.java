package com.coreyd97.antivirus.server.engine;

import com.coreyd97.antivirus.common.report.Report;
import com.coreyd97.antivirus.common.report.ReportHandler;
import com.coreyd97.antivirus.common.report.ResultsReport;
import com.coreyd97.antivirus.common.report.ScanReport;
import com.coreyd97.antivirus.common.taskscheduler.AnalysisTask;
import com.coreyd97.antivirus.common.taskscheduler.Task;
import com.coreyd97.antivirus.common.taskscheduler.TaskListener;
import com.coreyd97.antivirus.common.taskscheduler.TaskScheduler;
import com.coreyd97.antivirus.server.network.ServerNetworkController;
import org.reflections.Reflections;

import java.lang.reflect.Field;
import java.lang.reflect.Modifier;
import java.util.HashMap;
import java.util.Set;
import java.util.UUID;
import java.util.concurrent.Future;
import java.util.logging.Logger;

public class AnalysisManager implements TaskListener, ReportHandler {
    private final ServerNetworkController networkController;
    private final TaskScheduler taskScheduler;
    private HashMap<String, AnalysisModule> analysisModules;
    private HashMap<UUID, AnalysisTask> activeAnalysisTasks;
    private HashMap<UUID, ScanReport> pendingAnalysis;
    private HashMap<UUID, ResultsReport> resultsReports;

    public AnalysisManager(ServerNetworkController serverNetworkController, TaskScheduler taskScheduler) {
        this.networkController = serverNetworkController;
        this.taskScheduler = taskScheduler;
        this.activeAnalysisTasks = new HashMap<>();
        this.pendingAnalysis = new HashMap<>();
        this.resultsReports = new HashMap<>();
        loadDetectionModules();
    }

    //Register request for a scan with the scheduler. This will be executed when scheduler is ready.
    public Future<ResultsReport> requestAnalysis(ScanReport scanReport) throws UnknownModuleException {
        //TODO Remove hardcoded scanner engine
        AnalysisModule detectionModule = analysisModules.get(scanReport.getScannerModule());
        if(detectionModule == null){ throw new UnknownModuleException(scanReport.getScannerModule()); }
        AnalysisTask analysisTask = detectionModule.processReport(scanReport);
        analysisTask.setReportHandler(this);
        analysisTask.registerTaskListener(this);
        return taskScheduler.submitFutureTask(analysisTask);
    }

    //Create and return scan task ready for manual start
    public AnalysisTask analyseNow(ScanReport scanReport) throws UnknownModuleException {
        AnalysisModule detectionModule = analysisModules.get(scanReport.getScannerModule());
        if(detectionModule == null){ throw new UnknownModuleException(scanReport.getScannerModule()); }
        AnalysisTask task = detectionModule.processReport(scanReport);
        task.setReportHandler(this);
        task.registerTaskListener(this);
        taskScheduler.registerTask(task);
        return task;
    }

    @Override
    public void onReportReady(Report report) {
        resultsReports.put(report.getUUID(), (ResultsReport) report);
        if(((ResultsReport) report).getFoundMalware().size() > 0){
            //TODO Malware Detected! Quarantine the system.
        }else{
            //TODO Simplify results reports which are clean.
        }
    }

    @Override
    public void onTaskStart(Task task, int steps) {
        activeAnalysisTasks.put(task.getUUID(), (AnalysisTask) task);
    }

    @Override
    public void onTaskStepsAdded(Task task, int steps) {}

    @Override
    public void onTaskProgress(Task task) {}

    @Override
    public void onTaskComplete(Task task) {
        activeAnalysisTasks.remove(task.getUUID());
    }

    public ResultsReport getReport(UUID uuid){
        return resultsReports.remove(uuid);
    }

    private void loadDetectionModules() {
        this.analysisModules = new HashMap<>();
        Reflections reflections = new Reflections("com.coreyd97.antivirus.server.engine");
        Set<Class<? extends AnalysisModule>> analysisModule = reflections.getSubTypesOf(AnalysisModule.class);
        for (Class<? extends AnalysisModule> module : analysisModule) {
            if(Modifier.isAbstract(module.getModifiers())) continue;
            String name; //Try to get engine name defined in class. Otherwise use file name.
            try {
                Field f = module.getField("engineName");
                name = (String) f.get(null);
            } catch (NoSuchFieldException | IllegalAccessException e) {
                name = module.getName();
            }
            AnalysisModule instance;
            try {
                instance = module.newInstance();
                this.analysisModules.put(name, instance);
            } catch (InstantiationException | IllegalAccessException e) {
                Logger.getLogger("AnalysisManager").warning("Analysis module " + name + " could not be loaded!");
            }
        }
    }

}


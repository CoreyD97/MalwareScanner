package com.coreyd97.antivirus.server.taskscheduler;

import com.coreyd97.antivirus.common.report.*;
import com.coreyd97.antivirus.common.taskscheduler.AnalysisTask;
import com.coreyd97.antivirus.common.taskscheduler.Task;
import com.coreyd97.c45.DataElement;
import com.coreyd97.c45.TreeNode;

import java.sql.SQLException;
import java.util.logging.Logger;

/**
 * Base class for explain tasks.
 */
public abstract class ExplainTask extends AnalysisTask {

    TreeNode tree;

    protected ExplainTask(String taskName, TreeNode decisionTree, ScanReport scanReport) {
        super(taskName, scanReport);
        this.tree = decisionTree;
    }

    //Util to describe the path taken down a decision tree.
    protected String explain(DataElement element){
        String exp = "";
        TreeNode currentNode = tree;
        while(!currentNode.isTerminal){
            String attr = getReadableAttribute(currentNode.attribute);
            if(currentNode.isBoolean){
                for (TreeNode child : currentNode.children) {
                    String nodeVal = String.valueOf(element.labels.contains(currentNode.attribute));
                    if(child.value.equals(nodeVal)){
                        exp += "\t" + attr + "=" + nodeVal + "\n";
                        currentNode = child;
                        break;
                    }
                }
            }else if(currentNode.isCategoric){
                for (TreeNode child : currentNode.children) {
                    String nodeVal = element.features.get(currentNode.attribute);
                    if(child.value.equals(nodeVal)){
                        exp += "\t" + getReadableAttribute(currentNode.attribute) + "=" + nodeVal + "\n";
                        currentNode = child;
                        break;
                    }
                }
            }
        }
        return exp + "\t\tCLASSIFICATION=" + currentNode.classification;
    }

    public void setTree(TreeNode tree) {
        this.tree = tree;
    }

    public abstract String getReadableAttribute(String attribute);
}

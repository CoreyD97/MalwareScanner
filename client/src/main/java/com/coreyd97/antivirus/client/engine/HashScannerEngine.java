package com.coreyd97.antivirus.client.engine;

import com.coreyd97.antivirus.client.AntiVirus;
import com.coreyd97.antivirus.common.engine.ClientScannerEngine;
import com.coreyd97.antivirus.common.report.ScanReport;
import com.coreyd97.antivirus.common.taskscheduler.FileTask;
import com.coreyd97.antivirus.common.utils.Utils;

import java.io.File;
import java.io.IOException;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.util.ArrayList;
import java.util.HashMap;

public class HashScannerEngine extends ClientScannerEngine {
    public static final String engineName = "Hash Scanner";
    private Utils.HashType hashType;

    public HashScannerEngine(Utils.HashType hashType) {
        super(engineName, ReportType.BATCH);
        this.hashType = hashType;
    }

    @Override
    public FileTask scan(File[] files) {
        FileTask scanTask = new BasicScanTask("Basic Scan", files, new ScanReport(this));
        AntiVirus.getInstance().getTaskScheduler().registerTask(scanTask);
        return scanTask;
    }

    private class BasicScanTask extends FileTask {

        BasicScanTask(String name, File[] files, ScanReport scanReport) {
            super(name, files, scanReport);
        }

        @Override
        protected void processFile(File file) {
            HashMap<String, String> features = new HashMap<>();
            features.put("HashType", hashType.toString());
            try {
                features.put(hashType.toString(), Utils.fileChecksum(MessageDigest.getInstance(hashType.toString()), file));
            } catch (NoSuchAlgorithmException | IOException e) {}

            ((ScanReport) report).addFile(file, features);
        }
    }

}

package com.coreyd97.antivirus.client;

import com.coreyd97.antivirus.client.engine.ScanManager;
import com.coreyd97.antivirus.client.network.CheckConnectionTask;
import com.coreyd97.antivirus.common.engine.CryptoManager;
import com.coreyd97.antivirus.common.network.ServerConnectionHandler;
import com.coreyd97.antivirus.common.stats.StatProviderManager;
import com.coreyd97.antivirus.common.taskscheduler.TaskScheduler;
import com.coreyd97.antivirus.client.ui.AntiVirusUI;
import com.coreyd97.antivirus.common.Options;
import com.coreyd97.antivirus.common.utils.Utils;

import javax.swing.*;
import java.io.File;
import java.io.IOException;
import java.net.InetAddress;
import java.net.UnknownHostException;
import java.security.InvalidKeyException;
import java.security.NoSuchAlgorithmException;
import java.security.spec.InvalidKeySpecException;

public class AntiVirusClient {
    private Options options;
    private final TaskScheduler taskScheduler;
    private final ScanManager scanManager;
    private final CryptoManager cryptoManager;
    private final ServerConnectionHandler analysisConnectionHandler;
    private final StatProviderManager statProviderManager;

    private AntiVirusClient() {
        this.options = new Options(new File("config/clientconfig.json"));
        CryptoManager tempCryptoManager = null;
        try {
            tempCryptoManager = new CryptoManager(new File("config/clientkey.private"));
        } catch (NoSuchAlgorithmException | IOException | InvalidKeySpecException | InvalidKeyException e) {
            System.err.println("Could not load client keys..." + e.getMessage());
            System.exit(0);
        }
        this.cryptoManager = tempCryptoManager;

        String address = this.options.getValue("server.address", String.class, "0.0.0.0");
        InetAddress serveraddress = null;
        try {
            serveraddress = InetAddress.getByName(address);
        } catch (UnknownHostException e) {}
        short serverport = this.options.getValue("server.port", Integer.class, 4396).shortValue();

        //Setup AV Components
        this.statProviderManager = new StatProviderManager();
        this.taskScheduler = new TaskScheduler(25);
        this.statProviderManager.addStatProvider(this.taskScheduler);


        String analysisServerPub = this.options.getValue("server.publickey", String.class, "");
        ServerConnectionHandler tempAnalysisConnectionHandler = null;
        try{
            tempAnalysisConnectionHandler = new ServerConnectionHandler(serveraddress, serverport, analysisServerPub, this.cryptoManager);
        } catch (NoSuchAlgorithmException | InvalidKeySpecException e) {
            System.err.println("Could not load Analysis server connection handler! Is the public key correct?");
            System.exit(0);
        }
        this.analysisConnectionHandler = tempAnalysisConnectionHandler;

        this.scanManager = new ScanManager(this.analysisConnectionHandler, this.taskScheduler);
        this.scanManager.start();
        this.statProviderManager.addStatProvider(this.scanManager);
    }

    public static void main(String[] args) {
        AntiVirusClient avClient = new AntiVirusClient();

        SwingUtilities.invokeLater(() -> {
//            try {
//                UIManager.setLookAndFeel(UIManager.getSystemLookAndFeelClassName());
//            } catch (ClassNotFoundException | InstantiationException | UnsupportedLookAndFeelException | IllegalAccessException e) {}
            new AntiVirusUI(avClient);
        });


        CheckConnectionTask task = new CheckConnectionTask(avClient.getAnalysisConnectionHandler());
        avClient.getTaskScheduler().execute(task);
        task.setCallback(() -> {
            if (task.getResult()) {

            } else {
                Utils.showMessage("Network Error", "Could not connect to server. Check the server is running and correctly configured.");
            }
        });
    }

//    public static AntiVirusClient getInstance() {
//        if (instance == null) instance = new AntiVirusClient();
//        return instance;
//    }

    public Options getOptions() {
        return options;
    }

    public void shutdown(){
        System.exit(0);
    }

    public TaskScheduler getTaskScheduler() {
        return taskScheduler;
    }

    public ServerConnectionHandler getAnalysisConnectionHandler() {
        return analysisConnectionHandler;
    }

    public ScanManager getScanManager() {
        return scanManager;
    }

    public StatProviderManager getStatProviderManager() {
        return statProviderManager;
    }
}

package com.coreyd97.antivirus.client.engine;

import com.coreyd97.antivirus.client.network.GetResultsTask;
import com.coreyd97.antivirus.client.network.SubmitExplainTask;
import com.coreyd97.antivirus.client.network.SubmitScanReportTask;
import com.coreyd97.antivirus.common.engine.ClientDetectionModule;
import com.coreyd97.antivirus.common.engine.YaraManager;
import com.coreyd97.antivirus.common.exception.UnknownScanModuleException;
import com.coreyd97.antivirus.common.network.ServerConnectionHandler;
import com.coreyd97.antivirus.common.report.Report;
import com.coreyd97.antivirus.common.report.ReportHandler;
import com.coreyd97.antivirus.common.report.ResultsReport;
import com.coreyd97.antivirus.common.report.ScanReport;
import com.coreyd97.antivirus.common.stats.StatProvider;
import com.coreyd97.antivirus.common.taskscheduler.*;
import org.reflections.Reflections;

import javax.swing.*;
import javax.swing.border.TitledBorder;
import java.awt.*;
import java.io.File;
import java.lang.reflect.Field;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Modifier;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Set;
import java.util.UUID;
import java.util.logging.Logger;

public class ScanManager extends Thread implements TaskStatusListener<ScanTask>, ReportHandler<ScanReport>, StatProvider {
    private final ServerConnectionHandler networkController;
    private final TaskScheduler scheduler;
    private final YaraManager yaraManager;
    private final HashMap<String, ClientDetectionModule> scannerEngines;

    private final HashMap<UUID, ScanTask> activeScans;
    private final HashSet<UUID> reportsPendingAnalysis;
    private final HashMap<ScanReport, Boolean> reportsFailedSubmission;
    private boolean isGettingResults = false;
    private GetResultsTask resultsTask;


    public ScanManager(ServerConnectionHandler networkController, TaskScheduler taskScheduler){
        this.networkController = networkController;
        this.scheduler = taskScheduler;
        this.yaraManager = new YaraManager(new File[]{new File("config/rules/index.yar")});
        this.activeScans = new HashMap<>();
        this.reportsPendingAnalysis = new HashSet<>();
        this.reportsFailedSubmission = new HashMap<>();
        this.scannerEngines = new HashMap<>();

        //Use java reflection to load detection engines from package.
        //Allows "magic" loading of new modules without the need to hardcode.
        Reflections reflections = new Reflections("com.coreyd97.antivirus.client.engine");
        Set<Class<? extends ClientDetectionModule>> scannerEngines = reflections.getSubTypesOf(ClientDetectionModule.class);
        for (Class<? extends ClientDetectionModule> scannerEngine : scannerEngines) {
            if(Modifier.isAbstract(scannerEngine.getModifiers())) continue;
            String name; //Try to get engine taskName defined in class. Otherwise use file taskName.
            try {
                Field f = scannerEngine.getField("engineName");
                name = (String) f.get(null);
            } catch (NoSuchFieldException | IllegalAccessException e) {
                name = scannerEngine.getName();
            }
            try {
                ClientDetectionModule instance = scannerEngine.getConstructor(ScanManager.class).newInstance(this);
                this.scannerEngines.put(name, instance);
            } catch (InstantiationException | IllegalAccessException | NoSuchMethodException | InvocationTargetException e) {
                Logger.getAnonymousLogger().warning("Could not create instance of detection module \"" + name + "\"");
            }
        }
    }

    public HashMap<String, ClientDetectionModule> getScannerEngines() {
        return scannerEngines;
    }

    //Register request for a scan with the scheduler. This will be executed when scheduler is ready.
    public ScanTask requestScan(String engineName, File[] files) throws UnknownScanModuleException {
        ClientDetectionModule module = this.scannerEngines.get(engineName);
        if(module == null) throw new UnknownScanModuleException("No scan module found with taskName " + engineName);
        else{
            return requestScan(module, files);
        }
    }

    //Register request for a scan with the scheduler. This will be executed when scheduler is ready.
    public ScanTask requestScan(ClientDetectionModule scannerEngine, File[] files){
        ScanTask task = scannerEngine.generateScanTask(files);
        task.setReportHandler(this); //Tell the task to let us know when a report is ready
        task.registerStatusListener(this); //Tell the task to update us with any status changes
        scheduler.execute(task);
        return task;
    }


    //Register request for an explanation with the scheduler. This will be executed when scheduler is ready.
    public ScanTask requestExplanation(String engineName, File[] files) throws UnknownScanModuleException {
        ClientDetectionModule module = this.scannerEngines.get(engineName);
        if(module == null) throw new UnknownScanModuleException("No scan module found with taskName " + engineName);
        else{
            return requestExplanation(module, files);
        }
    }

    //Register request for an explanation with the scheduler. This will be executed when scheduler is ready.
    public ScanTask requestExplanation(ClientDetectionModule scannerEngine, File[] files){
        ScanTask task = scannerEngine.generateExplainTask(files);
        task.setReportHandler(this); //Tell the task to let us know when a report is ready
        task.registerStatusListener(this); //Tell the task to update us with any status changes
        scheduler.execute(task);
        return task;
    }

    @Override
    public void onReportReady(final ScanReport report) {
        //When a task tells us a report is ready
        NetworkTask<Boolean> submissionTask;
        if(report.getType() == ScanTask.ScanType.SCAN) {
            submissionTask = new SubmitScanReportTask(networkController, report);
        }else{
            submissionTask = new SubmitExplainTask(networkController, report);
        }
        //Submit for analysis and register pending scanReport

        submissionTask.setCallback(new Runnable() {
            @Override
            public void run() {
                if (submissionTask.getResult()) { //If the report was successfully submitted
                    synchronized (reportsPendingAnalysis) {
                        reportsPendingAnalysis.add(report.getUUID());
                    }
                    ScanTask task = activeScans.get(report.getTaskUUID());
                    if (task != null) {
                        task.logMessage(TaskLogListener.MessageType.INFO,
                                "Scan report was submitted for analysis.");
                    }
                } else { //If not submitted
                    synchronized (reportsFailedSubmission) {
                        reportsFailedSubmission.put(report, false);
                        ScanTask task = activeScans.get(report.getTaskUUID());
                        if (task != null) {
                            task.logMessage(TaskLogListener.MessageType.ERROR,
                                    "Could not execute scan task for analysis. Periodically retrying until success.");
                        }
                    }
                }
            }
        });
        //Ask scheduler to execute it when possible
        scheduler.execute(submissionTask);
    }

    @Override
    public void onTaskStart(ScanTask task, int steps) {
        synchronized (this.activeScans){
            //When a task is started, make a note of it.
            this.activeScans.put(task.getUUID(), task);
        }
    }

    @Override
    public void onTaskStepsAdded(ScanTask task, int steps) {}
    @Override
    public void onTaskProgress(ScanTask task) {}

    @Override
    public void onTaskComplete(ScanTask task) {
        synchronized (this.activeScans) {
            if(this.activeScans.remove(task.getUUID()) != null){
                //Scan complete and results returned. ScanManager doesn't need to do anything
            }
        }
    }

    @Override
    public void onTaskException(ScanTask task, Throwable throwable) {

    }

    @Override
    public void run() {
        while(true){
            synchronized (this.reportsFailedSubmission) {
                this.reportsFailedSubmission.forEach((scanReport, isRetrying) -> {
                    if(!isRetrying){ //If we've not currently got a task to retry submission
                        //Create a submission task for the scanReport
                        SubmitScanReportTask submitTask = new SubmitScanReportTask(networkController, scanReport);
                        submitTask.setCallback(() -> {
                            if(submitTask.getResult()){ //If the submission was a success.
                                ScanTask task = this.activeScans.get(scanReport.getTaskUUID());
                                if(task != null){ //Log that we've finally submitted the report for analysis.
                                    task.logMessage(TaskLogListener.MessageType.INFO, "Delayed scan report was finally submitted.");
                                }
                                synchronized (this.reportsFailedSubmission){
                                    this.reportsFailedSubmission.remove(scanReport);
                                }
                                synchronized (reportsPendingAnalysis) { //Store that we need to get the report results.
                                    reportsPendingAnalysis.add(scanReport.getUUID());
                                }
                            }else{ //Submission failed, mark as requiring reattempt.
                                synchronized (this.reportsFailedSubmission){
                                    this.reportsFailedSubmission.put(scanReport, false);
                                }
                            }
                        });
                        synchronized (this.reportsFailedSubmission) {
                            this.reportsFailedSubmission.put(scanReport, true);
                        }
                        scheduler.execute(submitTask);
                    }
                });
            }

            //If we've not got a task to get results already and there's pending results,
            //Ask the server for the status of each.
            if(!isGettingResults && reportsPendingAnalysis.size() > 0){
                UUID uuids[] = reportsPendingAnalysis.toArray(new UUID[]{});
                resultsTask = new GetResultsTask(networkController, uuids);
                resultsTask.setReportHandler(new ReportHandler() {
                    //When a resultreport is received from the server
                    @Override
                    public void onReportReady(Report report) {
                        ScanTask scanTask = ScanManager.this.activeScans.get(((ResultsReport) report).getTaskUUID());
                        if(scanTask != null){
                            //Tell the relevant task to process and collate the results.
                            scanTask.processAnalysisReport((ResultsReport) report);
                        }
                        ScanManager.this.reportsPendingAnalysis.remove(report.getUUID());
                    }
                });
                resultsTask.setCallback(new Runnable() {
                    @Override
                    public void run() {
                        ScanManager.this.isGettingResults = false;
                    }
                });
                isGettingResults = true;
                scheduler.execute(resultsTask);
            }

            try {
                Thread.sleep(5000);
            } catch (InterruptedException ignored) {}
        }
    }

    protected YaraManager getYaraManager() {
        return yaraManager;
    }

    private JPanel statPanel;
    private JLabel scannerEngineCount;
    private JLabel activeScanCount;
    private JLabel pendingCount;
    private JLabel pendingFailedCount;

    @Override
    public JPanel getStatPanel() {
        if(statPanel == null) {
            statPanel = new JPanel(new GridLayout(0,2));
            TitledBorder border = BorderFactory.createTitledBorder("Scan Manager");
            border.setTitleColor(Color.BLUE);
            statPanel.setBorder(border);

            scannerEngineCount = new JLabel();
            activeScanCount = new JLabel();
            pendingCount = new JLabel();
            pendingFailedCount = new JLabel();

            statPanel.add(scannerEngineCount);
            statPanel.add(activeScanCount);
            statPanel.add(pendingCount);
            statPanel.add(pendingFailedCount);
        }

        scannerEngineCount.setText("Scanner Engines: " + this.scannerEngines.size());
        activeScanCount.setText("Active Scan Count: " + this.activeScans.size());
        pendingCount.setText("Pending Report Count: " + this.reportsPendingAnalysis.size());
        pendingFailedCount.setText("Failed Submissions: " + this.reportsFailedSubmission.size());
        statPanel.revalidate();
        statPanel.repaint();
        return statPanel;
    }
}

package com.coreyd97.antivirus.client.engine;

import com.coreyd97.antivirus.common.engine.ClientDetectionModule;
import com.coreyd97.antivirus.common.report.FileFeatures;
import com.coreyd97.antivirus.common.report.ScanReport;
import com.coreyd97.antivirus.common.taskscheduler.ScanTask;
import com.coreyd97.antivirus.common.utils.Utils;

import java.io.File;
import java.io.IOException;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.util.HashMap;

public class HashDetectionModule extends ClientDetectionModule {
    public static final String engineName = "Hash Scanner";
    private Utils.HashType hashType;

    public HashDetectionModule() {
        super(engineName);
        this.hashType = Utils.HashType.MD5;
    }

    @Override
    public ScanTask generateScanTask(File[] files) {
        return new HashScanTask("Hash Scan", files, ScanTask.ScanType.SCAN);
    }

    @Override
    public ScanTask generateExplainTask(File[] files) {
        return new HashScanTask("Hash Scan Explanation", files, ScanTask.ScanType.EXPLAIN);
    }

    private class HashScanTask extends ScanTask {

        HashScanTask(String name, File[] files, ScanType scanType) {
            super(name, files, HashDetectionModule.this, scanType);
        }

        @Override
        protected boolean processFile(File file) {
            HashMap<FileFeatures.Feature, String> features = new HashMap<>();
            features.put(FileFeatures.Feature.HASH_TYPE, hashType.toString());
            try {
                features.put(FileFeatures.Feature.valueOf(hashType.toString()), Utils.fileChecksum(MessageDigest.getInstance(hashType.toString()), file));
            } catch (NoSuchAlgorithmException | IOException e) {}

            FileFeatures fileFeatures = report.addFile(file);
            fileFeatures.setFeatureMap(features);

            return true;
        }
    }

}

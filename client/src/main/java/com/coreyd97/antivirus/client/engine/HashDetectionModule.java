package com.coreyd97.antivirus.client.engine;

import com.coreyd97.antivirus.common.engine.ClientDetectionModule;
import com.coreyd97.antivirus.common.report.FileFeatures;
import com.coreyd97.antivirus.common.report.ScanReport;
import com.coreyd97.antivirus.common.taskscheduler.ScanTask;
import com.coreyd97.antivirus.common.utils.Utils;

import java.io.File;
import java.io.IOException;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.util.HashMap;

public class HashDetectionModule extends ClientDetectionModule {
    public static final String engineName = "Hash Scanner";
    private Utils.HashType hashType;

    public HashDetectionModule(Utils.HashType hashType) {
        super(engineName);
        this.hashType = hashType;
    }

    @Override
    public ScanTask generateScanTask(File[] files) {
        return new HashScanTask("Hash Scan", files);
    }

    private class HashScanTask extends ScanTask {

        HashScanTask(String name, File[] files) {
            super(name, files, HashDetectionModule.this);
        }

        @Override
        protected void processFile(File file) {
            HashMap<FileFeatures.Feature, String> features = new HashMap<>();
            features.put(FileFeatures.Feature.HASH_TYPE, hashType.toString());
            try {
                features.put(FileFeatures.Feature.valueOf(hashType.toString()), Utils.fileChecksum(MessageDigest.getInstance(hashType.toString()), file));
            } catch (NoSuchAlgorithmException | IOException e) {}

            FileFeatures fileFeatures = report.addFile(file);
            fileFeatures.setFeatureMap(features);
        }
    }

}

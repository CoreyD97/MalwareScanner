package com.coreyd97.antivirus.client.engine;

import com.coreyd97.antivirus.client.AntiVirus;
import com.coreyd97.antivirus.common.engine.ClientScannerEngine;
import com.coreyd97.antivirus.common.report.ScanReport;
import com.coreyd97.antivirus.common.taskscheduler.FileTask;
import com.coreyd97.antivirus.common.utils.Utils;
import com.github.katjahahn.parser.PEData;
import com.github.katjahahn.parser.PELoader;
import com.github.katjahahn.parser.sections.SectionLoader;
import com.github.katjahahn.parser.sections.idata.ImportDLL;
import com.github.katjahahn.parser.sections.idata.ImportSection;

import java.io.File;
import java.io.IOException;
import java.sql.SQLException;
import java.util.ArrayList;

public class ImportStatsHeuristicEngine extends ClientScannerEngine {
    public static final String engineName = "Function Import Heuristic";
    boolean storeSampleFunctionUsage;

    public ImportStatsHeuristicEngine(){
        super(engineName, ReportType.BATCH);
        storeSampleFunctionUsage = AntiVirus.getInstance().getOptions().getValue("storeFunctionUsage", Boolean.class, false);
    }

    @Override
    public FileTask scan(File[] files) {
        FileTask scanTask = new ImportStatsScanTask("Heuristic Scan", files, new ScanReport(this));
        AntiVirus.getInstance().getTaskScheduler().registerTask(scanTask);
        return scanTask;
    }


    private class ImportStatsScanTask extends FileTask {

        ImportStatsScanTask(String taskName, File files[], ScanReport report){
            super(taskName, files, report);
        }

        @Override
        protected void processFile(File file) {
            try {
                PEData data = PELoader.loadPE(file);
                SectionLoader sectionLoader = new SectionLoader(data);
                ImportSection section = sectionLoader.loadImportSection();
                ArrayList<ImportDLL> imports = (ArrayList<ImportDLL>) section.getImports();
                ((ScanReport) report).addFile(file, imports);

            } catch (IOException | IllegalStateException e) {
//                String cause;
//                if (e instanceof FileFormatException) {
//                    cause = "Invalid PE32 File. ";
//                } else if (e instanceof IllegalStateException) {
//                    cause = "Could not find import section. ";
//                } else {
//                    cause = "Could not open file. ";
//                }
//                ((TrainReport) this.report).addFailedSample(cause, file.getAbsolutePath());
            }
        }
    }
}

package com.coreyd97.antivirus.client.engine;

import com.coreyd97.antivirus.common.engine.ClientDetectionModule;
import com.coreyd97.antivirus.common.report.ScanReport;
import com.coreyd97.antivirus.common.report.TrainReport;
import com.coreyd97.antivirus.common.taskscheduler.ScanTask;
import com.coreyd97.antivirus.common.utils.ScannerEngineUtils;
import com.github.plusvic.yara.*;
import com.github.plusvic.yara.embedded.YaraLibrary;

import java.io.File;
import java.util.ArrayList;

public class RulesDetectionModule extends ClientDetectionModule {
    public static final String engineName = "Yara Rule Engine";
    private YaraLibrary library;
    private YaraCompiler compiler;
    private Yara yara;
    private boolean isSetup;

    public RulesDetectionModule() {
        super(engineName);
    }

    private void setup(){
        this.yara = YaraFactory.create(YaraFactory.Mode.EMBEDDED);
        this.compiler = yara.createCompiler();

        ScannerEngineUtils.RuleImportTask importTask = new ScannerEngineUtils.RuleImportTask(new File[]{new File("config/rules/index.yar")}, RulesDetectionModule.this, yara, compiler);
        importTask.run();
        this.isSetup = true;
    }

    @Override
    public ScanTask generateScanTask(File[] files) {
        return new RuleScanTask(files);
    }

    private class RuleScanTask extends ScanTask {
        YaraScanner scanner;
        File activeFile;
        ArrayList<String> activeFileMatches;

        RuleScanTask(File[] files) {
            super("Yara Rule Scan", files, RulesDetectionModule.this);
        }

        @Override
        protected void processFile(File file) {
            activeFileMatches = new ArrayList<>();
            try {
                activeFile = file;
                scanner.scan(file);
            }catch (YaraException e){}
            ((ScanReport) report).addFile(activeFile, activeFileMatches);
        }

        @Override
        public void run() {
            if(!RulesDetectionModule.this.isSetup){
                setup();
            }
            scanner = compiler.createScanner();
            scanner.setCallback(new YaraScanCallback() {
                @Override
                public void onMatch(YaraRule yaraRule) {
                    activeFileMatches.add(yaraRule.getIdentifier());
                }
            });
            super.run();
            yara.finalizeThread();
        }
    }


    @Override
    public String toString() {
        return getModuleName();
    }
}

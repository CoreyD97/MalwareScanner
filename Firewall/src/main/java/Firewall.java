import com.coreyd97.antivirus.common.Options;
import com.coreyd97.antivirus.common.engine.CryptoManager;

import java.io.File;
import java.io.IOException;
import java.security.InvalidKeyException;
import java.security.NoSuchAlgorithmException;
import java.security.spec.InvalidKeySpecException;
import java.util.Base64;

public class Firewall {

    private final Options options;
    private final FirewallClientHandler serverThread;
    private final ClientManager clientManager;
    private final CryptoManager cryptoManager;

    Firewall(){
        this.options = new Options(new File("config/firewallconfig.json"));

        CryptoManager tempCryptoManager = null;
        try {
            tempCryptoManager = new CryptoManager(new File("config/firewallkey.private"));
        } catch (NoSuchAlgorithmException | IOException | InvalidKeySpecException | InvalidKeyException e) {
            System.err.println("Could not load firewall keys..." + e.getMessage());
            System.exit(0);
        }
        this.cryptoManager = tempCryptoManager;

        //Print our public key so we can give it to clients
        String encoded = Base64.getEncoder().encodeToString(this.cryptoManager.getPublicKey().getEncoded());
        System.out.println("Firewall public key: " + encoded);

        clientManager = new ClientManager();

        short serverPort = this.options.getValue("firewallServerPort", Short.class, (short) 4397);

        FirewallClientHandler tempFirewallClientHandler = null;
        try {
            tempFirewallClientHandler = new FirewallClientHandler(clientManager, cryptoManager, serverPort);
        } catch (IOException e) {
            System.err.println("Could not start server on port " + serverPort + ". Exiting...");
            System.exit(1);
        }
        this.serverThread = tempFirewallClientHandler;
        this.serverThread.start();

    }

    public Options getOptions() {
        return options;
    }

    public ClientManager getClientManager() {
        return clientManager;
    }

    public static void main(String[] args) {
        Firewall firewall = new Firewall();
    }
}

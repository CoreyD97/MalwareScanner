import com.coreyd97.antivirus.common.network.ClientConnection;
import com.coreyd97.antivirus.common.network.ServerThread;
import org.apache.commons.codec.DecoderException;

import java.io.IOException;
import java.net.Inet4Address;
import java.net.Socket;
import java.net.UnknownHostException;
import java.security.GeneralSecurityException;

public class FirewallClientConnection extends ClientConnection {

    private final ClientManager clientManager;

    public FirewallClientConnection(ServerThread serverThread, Socket clientSocket) throws IOException {
        super(serverThread, clientSocket);
        this.clientManager = ((FirewallClientHandler) serverThread).getClientManager();
    }

    @Override
    protected void interact() throws GeneralSecurityException, IOException, DecoderException {
        String line;
        while (!this.isClosed()) {
            line = readLine();
            if(line == null) continue;
            switch (line) {
                case "BAN": {
                    line = readLine();
                    try {
                        Inet4Address addr = (Inet4Address) Inet4Address.getByName(line);
                        clientManager.banClient(addr);
                        send("SUCCESS");
                    }catch (UnknownHostException unknownHostException){
                        send("FAIL");
                    }
                    endConnection();
                    break;
                }
                case "UNBAN": {
                    line = readLine();
                    try {
                        Inet4Address addr = (Inet4Address) Inet4Address.getByName(line);
                        clientManager.unbanClient(addr);
                        send("SUCCESS");
                    }catch (UnknownHostException unknownHostException){
                        send("FAIL");
                    }
                    endConnection();
                    break;
                }
                case "WHITELIST": {
                    line = readLine();
                    try {
                        Inet4Address addr = (Inet4Address) Inet4Address.getByName(line);
                        clientManager.addWhitelistedAddress(addr);
                        send("SUCCESS");
                    }catch (UnknownHostException unknownHostException){
                        send("FAIL");
                    }
                    endConnection();
                    break;
                }
                case "UNWHITELIST": {
                    line = readLine();
                    try {
                        Inet4Address addr = (Inet4Address) Inet4Address.getByName(line);
                        clientManager.removeWhitelistAddress(addr);
                        send("SUCCESS");
                    }catch (UnknownHostException unknownHostException){
                        send("FAIL");
                    }
                    endConnection();
                    break;
                }
                case "LISTBANS": {
                    for (Inet4Address inet4Address : clientManager.getBannedClients()) {
                        send(inet4Address.getHostAddress());
                    }
                    send("END");
                    endConnection();
                    break;
                }
            }
        }
    }
}

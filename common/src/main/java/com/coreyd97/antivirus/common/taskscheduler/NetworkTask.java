package com.coreyd97.antivirus.common.taskscheduler;

import com.coreyd97.antivirus.common.network.NetworkController;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.PrintWriter;
import java.net.Socket;
import java.util.logging.Logger;

public abstract class NetworkTask extends Task {

    protected final NetworkController networkController;
    protected Socket socket;
    protected BufferedReader input;
    protected PrintWriter output;

    protected NetworkTask(String taskName, NetworkController networkController) {
        super(taskName);
        this.networkController = networkController;
    }

    protected abstract Object interact() throws IOException;
    protected abstract Object onFailure();


    //Setup socket input/output before calling subclass interact method.
    @Override
    public Object call() throws Exception {
        taskStart(1);
        try{
            socket = this.networkController.establishConnection();
            input = new BufferedReader(new InputStreamReader(socket.getInputStream()));
            output = new PrintWriter(socket.getOutputStream(), true);
            return interact();
        }catch (IOException e){
            Logger.getLogger("Network Task").warning(e.getMessage());
            return onFailure();
        }finally {
            taskProgress();
            taskComplete();
            socket.close();
            input.close();
            output.close();
        }
    }
}

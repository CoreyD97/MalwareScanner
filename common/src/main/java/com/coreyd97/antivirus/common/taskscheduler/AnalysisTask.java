package com.coreyd97.antivirus.common.taskscheduler;

import com.coreyd97.antivirus.common.report.*;

import java.sql.SQLException;
import java.util.logging.Logger;

public abstract class AnalysisTask extends Task implements ReportPublisher {
    protected ScanReport report;
    protected ResultsReport resultsReport;
    private ReportHandler reportHandler;

    protected AnalysisTask(String taskName, ScanReport report){
        this(taskName, report, new ResultsReport(report));
    }

    protected AnalysisTask(String taskName, ScanReport report, ResultsReport resultsReport) {
        super(taskName);
        this.report = report;
        this.resultsReport = resultsReport;
    }

    public void setReportHandler(ReportHandler reportHandler){
        this.reportHandler = reportHandler;
    }

    //Implement in subclasses to define handling of each file.
    protected abstract void processFile(FileFeatures features) throws SQLException;

    private void processReport(){
        this.reportHandler.onReportReady(resultsReport);
    }

    public Report call() throws Exception {
        taskStart(report.getFileFeatures().size());
        report.getFileFeatures().forEach(fileFeatures -> {
            try {
                processFile(fileFeatures);
            } catch (SQLException e) {
                Logger.getLogger("Analysis").warning("SQL EXCEPTION - " + e.getSQLState());
            }
            taskProgress();
        });
        taskComplete();
        processReport();
        return resultsReport;
    }
}

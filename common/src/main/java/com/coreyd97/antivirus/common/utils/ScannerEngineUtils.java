package com.coreyd97.antivirus.common.utils;

import com.coreyd97.antivirus.common.taskscheduler.TrainTask;
import com.github.plusvic.yara.Yara;
import com.github.plusvic.yara.YaraCompilationCallback;
import com.github.plusvic.yara.YaraCompiler;
import com.github.plusvic.yara.YaraException;

import java.io.File;

public class ScannerEngineUtils {

    public static class RuleImportTask extends TrainTask {
        Yara yara;
        YaraCompiler compiler;

        public RuleImportTask(File[] files, Yara yara, YaraCompiler compiler) {
            super("Yara Rule Import", files);
            this.yara = yara;
            this.compiler = compiler;
        }

        @Override
        protected boolean processFile(File file) {
            try {
                compiler.addRulesFile(file.getAbsolutePath(), file.getAbsolutePath(), null);
                return true;
            }catch (YaraException e){}
            return false;
        }

        @Override
        public void run() {
            YaraCompilationCallback compilationCallback = new YaraCompilationCallback() {
                @Override
                public void onError(ErrorLevel errorLevel, String file, long line, String message) {
                    if(errorLevel == ErrorLevel.ERROR) {
                        result.addFailedSample(String.format("Yara compilation failed. %s", message));
                    }
                }
            };
            compiler.setCallback(compilationCallback);

            super.run();

            yara.finalizeThread();
            if(this.callback != null) {
                this.callback.run();
            }
        }

        @Override
        public int getPriority() {
            return 100;
        }
    }


//    TODO move rule import task to within extraction tasks.
}

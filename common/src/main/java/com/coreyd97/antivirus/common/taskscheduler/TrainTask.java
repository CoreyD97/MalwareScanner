package com.coreyd97.antivirus.common.taskscheduler;

import com.coreyd97.antivirus.common.engine.ClientDetectionModule;
import com.coreyd97.antivirus.common.engine.DetectionModule;
import com.coreyd97.antivirus.common.report.ReportHandler;
import com.coreyd97.antivirus.common.report.ReportPublisher;
import com.coreyd97.antivirus.common.report.ScanReport;
import com.coreyd97.antivirus.common.report.TrainReport;

import java.io.File;

public abstract class TrainTask extends Task<TrainReport> implements ReportPublisher {
    enum ReportFrequency {SINGLE, BATCH, INDIVIDUAL}
    private File[] files;
    protected TrainReport report;
    protected ReportFrequency reportFrequency;
    private ReportHandler reportHandler;
    private int pendingReports = 0;

    protected TrainTask(String taskName, File[] files, DetectionModule detectionModule) {
        this(taskName, files, detectionModule, ReportFrequency.BATCH);
    }

    protected TrainTask(String taskName, File[] files, DetectionModule detectionModule, ReportFrequency reportFrequency) {
        super(taskName);
        this.files = files;
        this.report = new TrainReport(detectionModule, this);
        this.reportFrequency = reportFrequency;
    }

    public void setReportHandler(ReportHandler reportHandler){
        this.reportHandler = reportHandler;
    }

    //Implement in subclasses to define handling of each file.
    protected abstract void processFile(File file);

    private void processFiles(File files[]){
        for (File file : files) {
            if(file.isDirectory()){
                File[] childFiles = file.listFiles();
                if(childFiles == null) return;
                taskAddSteps(childFiles.length);
                processFiles(childFiles);
            }else{
                //Fill scanReport with file features
                processFile(file);
                publishReport();
                taskProgress();
            }
        }
    }

    private void publishReport(){
        if(this.reportHandler == null) return;
        try {
            switch (reportFrequency) {
                case INDIVIDUAL: {
                    this.reportHandler.onReportReady(report);
                    this.report = report.getClass().newInstance();
                    break;
                }
                case BATCH: {
                    if(this.pendingReports++ == 100){
                        this.reportHandler.onReportReady(report);
                        this.report = report.getClass().newInstance();
                        this.pendingReports = 0;
                    }
                    break;
                }
            }
        } catch (IllegalAccessException | InstantiationException ignored) {}
    }

    public void run() {
        taskStart(files.length);
        processFiles(this.files);
        if(this.reportHandler != null) {
            if (this.reportFrequency == ReportFrequency.SINGLE) {
                this.reportHandler.onReportReady(report);
            } else if (this.reportFrequency == ReportFrequency.BATCH && this.pendingReports != 0) {
                this.reportHandler.onReportReady(report);
            }
        }
        taskComplete();
        this.completed = true;
        if(this.callback != null)
            this.callback.run();
    }

    public TrainReport getReport() {
        return report;
    }
}
